From: Markus Koschany <apo@debian.org>
Date: Mon, 15 Aug 2022 23:34:12 +0200
Subject: CVE-2022-27782 part1

Origin: https://github.com/curl/curl/commit/f18af4f874cecab82a9797e8c7541e0990c7a64c
---
 lib/url.c       |    1 +
 lib/urldata.h   |    1 +
 lib/vtls/vtls.c |   41 +++++++++++++++++++++++++++++++++++++++++
 3 files changed, 43 insertions(+)

--- a/lib/url.c
+++ b/lib/url.c
@@ -3690,6 +3690,7 @@
 
   conn->verifypeer = data->set.ssl.verifypeer;
   conn->verifyhost = data->set.ssl.verifyhost;
+  conn->ssl_config.ssl_options = data->set.ssl.ssl_options;
 
   conn->ip_version = data->set.ipver;
 
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -385,6 +385,7 @@
   char *password; /* TLS password (for, e.g., SRP) */
   enum CURL_TLSAUTH authtype; /* TLS authentication type (default SRP) */
 #endif
+  unsigned char ssl_options;  /* the CURLOPT_SSL_OPTIONS bitmask */
 };
 
 /* information stored about one single SSL session */
--- a/lib/vtls/vtls.c
+++ b/lib/vtls/vtls.c
@@ -105,11 +105,18 @@
                         struct ssl_config_data* needle)
 {
   if((data->version == needle->version) &&
+     (data->ssl_options == needle->ssl_options) &&
      (data->verifypeer == needle->verifypeer) &&
      (data->verifyhost == needle->verifyhost) &&
      Curl_safecmp(data->CApath, needle->CApath) &&
      Curl_safecmp(data->CAfile, needle->CAfile) &&
      Curl_safecmp(data->clientcert, needle->clientcert) &&
+#ifdef USE_TLS_SRP
+     Curl_safecmp(data->username, needle->username) &&
+     Curl_safecmp(data->password, needle->password) &&
+     (data->authtype == needle->authtype) &&
+#endif
+     Curl_safecmp(data->CRLfile, needle->CRLfile) &&
      Curl_safecmp(data->random_file, needle->random_file) &&
      Curl_safecmp(data->egdsocket, needle->egdsocket) &&
      Curl_safecmp(data->cipher_list, needle->cipher_list))
@@ -126,6 +133,10 @@
   dest->verifyhost = source->verifyhost;
   dest->verifypeer = source->verifypeer;
   dest->version = source->version;
+  dest->ssl_options = source->ssl_options;
+#ifdef USE_TLS_SRP
+  dest->authtype = source->authtype;
+#endif
 
   if(source->CAfile) {
     dest->CAfile = strdup(source->CAfile);
@@ -176,6 +187,31 @@
   else
     dest->clientcert = NULL;
 
+  if(source->CRLfile) {
+    dest->CRLfile = strdup(source->CRLfile);
+    if(!dest->CRLfile)
+      return FALSE;
+  }
+  else
+    dest->CRLfile = NULL;
+
+#ifdef USE_TLS_SRP
+  if(source->username) {
+    dest->username = strdup(source->username);
+    if(!dest->username)
+      return FALSE;
+  }
+  else
+    dest->username = NULL;
+
+  if(source->password) {
+    dest->password = strdup(source->password);
+    if(!dest->password)
+      return FALSE;
+  }
+  else
+    dest->password = NULL;
+#endif
   return TRUE;
 }
 
@@ -187,6 +223,11 @@
   Curl_safefree(sslc->egdsocket);
   Curl_safefree(sslc->random_file);
   Curl_safefree(sslc->clientcert);
+  Curl_safefree(sslc->CRLfile);
+#ifdef USE_TLS_SRP
+  Curl_safefree(sslc->username);
+  Curl_safefree(sslc->password);
+#endif
 }
 
 
