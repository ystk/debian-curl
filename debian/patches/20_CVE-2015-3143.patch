From b2c0699645a64125cee11c114fed72b643793b03 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Thu, 16 Apr 2015 13:26:46 +0200
Subject: [PATCH] ConnectionExists: for NTLM re-use, require credentials to
 match

Bug: http://curl.haxx.se/docs/adv_20150422A.html
Reported-by: Paras Sethia
---
 lib/url.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: curl-7.21.0/lib/url.c
===================================================================
--- curl-7.21.0.orig/lib/url.c	2015-04-26 19:13:54.000000000 +0200
+++ curl-7.21.0/lib/url.c	2015-04-26 19:36:57.000000000 +0200
@@ -2999,8 +2999,9 @@
           }
         }
         if((!(needle->protocol & PROTOPT_CREDSPERREQUEST)) ||
-           ((needle->protocol & PROT_HTTP) &&
-            (data->state.authhost.want & CURLAUTH_NTLM))) {
+           (((needle->protocol & PROT_HTTP) &&
+             (data->state.authhost.want & CURLAUTH_NTLM)) ||
+             check->ntlm.state != NTLMSTATE_NONE)) {
           /* This protocol requires credentials per connection or is HTTP+NTLM,
              so verify that we're using the same name and password as well */
           if(!strequal(needle->user, check->user) ||
