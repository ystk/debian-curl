From: Markus Koschany <apo@debian.org>
Date: Mon, 15 Aug 2022 23:40:28 +0200
Subject: CVE-2022-27782 part2

Origin: https://github.com/curl/curl/commit/1645e9b44505abd5cbaf65da5282c3f33b5924a5
---
 lib/url.c |   13 +++++++++++++
 1 file changed, 13 insertions(+)

--- a/lib/url.c
+++ b/lib/url.c
@@ -477,6 +477,12 @@
   return CURLE_OK;
 }
 
+static bool ssh_config_matches(struct connectdata *one,
+                               struct connectdata *two)
+{
+  return (Curl_safecmp(one->proto.sshc.rsa, two->proto.sshc.rsa) &&
+          Curl_safecmp(one->proto.sshc.rsa_pub, two->proto.sshc.rsa_pub));
+}
 /*
  * Initialize the UserDefined fields within a SessionHandle.
  * This may be safely called on a new or existing SessionHandle.
@@ -3143,6 +3149,13 @@
         }
       }
 
+      if(needle->handler->protocol == CURLPROTO_SCP ||
+         needle->handler->protocol == CURLPROTO_SFTP) {
+
+        if(!ssh_config_matches(needle, check))
+          continue;
+      }
+
       if(!needle->bits.httpproxy || needle->handler->flags&PROTOPT_SSL ||
          (needle->bits.httpproxy && check->bits.httpproxy &&
           needle->bits.tunnel_proxy && check->bits.tunnel_proxy &&
