Description: Fix connection re-use when using different log-in credentials
 In addition to FTP, other connection based protocols such as IMAP, POP3,
 SMTP, SCP, SFTP and LDAP require a new connection when different log-in
 credentials are specified. Fixed the detection logic to include these
 other protocols.
Origin: upstream, http://curl.haxx.se/libcurl-bad-reuse.patch
Forwarded: not-needed
Author: Steve Holme <steve_holme@hotmail.com>
Last-Update: 2014-04-09

--- a/lib/http.c
+++ b/lib/http.c
@@ -162,7 +162,7 @@
   ZERO_NULL,                            /* perform_getsock */
   ZERO_NULL,                            /* disconnect */
   PORT_HTTPS,                           /* defport */
-  PROT_HTTP | PROT_HTTPS | PROT_SSL     /* protocol */
+  PROT_HTTP | PROT_HTTPS | PROT_SSL | PROTOPT_CREDSPERREQUEST    /* protocol */
 };
 #endif
 
--- a/lib/url.c
+++ b/lib/url.c
@@ -2986,11 +2986,11 @@
             continue;
           }
         }
-        if((needle->protocol & PROT_FTP) ||
+        if((!(needle->protocol & PROTOPT_CREDSPERREQUEST)) ||
            ((needle->protocol & PROT_HTTP) &&
             (data->state.authhost.want & CURLAUTH_NTLM))) {
-          /* This is FTP or HTTP+NTLM, verify that we're using the same name
-             and password as well */
+          /* This protocol requires credentials per connection or is HTTP+NTLM,
+             so verify that we're using the same name and password as well */
           if(!strequal(needle->user, check->user) ||
              !strequal(needle->passwd, check->passwd)) {
             /* one of them was different */
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -721,6 +721,8 @@
 #define PROT_EXTMASK 0xffffff
 
 #define PROT_SSL     (1<<29) /* protocol requires SSL */
+#define PROTOPT_CREDSPERREQUEST (1<<30) /* requires login creditials per request
+                                           as opposed to per connection */
 
 /* these ones need action before socket close */
 #define PROT_CLOSEACTION (PROT_FTP | PROT_IMAP | PROT_POP3)
--- a/tests/data/DISABLED
+++ b/tests/data/DISABLED
@@ -2,5 +2,6 @@
 # test cases are run by runtests.pl. Just add the plain test case numbers, one
 # per line.
 # Lines starting with '#' letters are treated as comments.
+519
 563
 564
