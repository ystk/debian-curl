The following sequence of patches is based on these upstream commits:
https://github.com/curl/curl/commit/08b8ef4e726ba10f45081ecda5b3cea788d3c839
https://github.com/curl/curl/commit/620ea21410030a9977396b4661806bc187231b79
https://github.com/curl/curl/commit/5295e8d64ac6949ecb3f9e564317a608f51b90d8
https://github.com/curl/curl/commit/139a54ed0a172adaaf1a78d6f4fff50b2c3f9e08

It is further based on work by Kamil Dudka <kdudka@redhat.com> for
CentOS 8 and CentOS 9:
https://gitlab.com/redhat/centos-stream/rpms/curl/-/blob/c9s/0013-curl-7.76.1-CVE-2022-27774.patch
https://gitlab.com/redhat/centos-stream/rpms/curl/-/blob/c8s/0038-curl-7.61.1-CVE-2022-27774.patch


From 48f126157d36962e458bf12f90b50cfcef26eee9 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Mon, 25 Apr 2022 16:24:33 +0200
Subject: [PATCH 1/4] connect: store "conn_remote_port" in the info struct

To make it available after the connection ended.

Upstream-commit: 08b8ef4e726ba10f45081ecda5b3cea788d3c839
Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 lib/connect.c |    3 +++
 lib/getinfo.c |    3 +++
 lib/urldata.h |    9 ++++++++-
 3 files changed, 14 insertions(+), 1 deletion(-)

--- a/lib/connect.c
+++ b/lib/connect.c
@@ -597,7 +597,10 @@
 {
   memcpy(conn->data->info.conn_primary_ip, conn->primary_ip, MAX_IPADR_LEN);
   memcpy(conn->data->info.conn_local_ip, conn->local_ip, MAX_IPADR_LEN);
+  conn->data->info.conn_scheme = conn->handler->scheme;
+  conn->data->info.conn_protocol = conn->handler->protocol;
   conn->data->info.conn_primary_port = conn->primary_port;
+  conn->data->info.conn_remote_port = conn->remote_port;
   conn->data->info.conn_local_port = conn->local_port;
 }
 
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -1117,11 +1117,18 @@
      reused, in the connection cache. */
 
   char conn_primary_ip[MAX_IPADR_LEN];
-  long conn_primary_port;
+  long conn_primary_port;/* this is the destination port to the connection,
+                            which might have been a proxy */
+  int conn_remote_port;  /* this is the "remote port", which is the port
+                            number of the used URL, independent of proxy or
+                            not */
 
   char conn_local_ip[MAX_IPADR_LEN];
   long conn_local_port;
 
+  const char *conn_scheme;
+  unsigned int conn_protocol;
+
   struct curl_certinfo certs; /* info about the certs, only populated in
                                  OpenSSL builds. Asked for with
                                  CURLOPT_CERTINFO / CURLINFO_CERTINFO */
--- a/lib/getinfo.c
+++ b/lib/getinfo.c
@@ -71,6 +71,9 @@
   info->conn_primary_port = 0;
   info->conn_local_port = 0;
 
+  info->conn_scheme = 0;
+  info->conn_protocol = 0;
+
   return CURLE_OK;
 }
 
