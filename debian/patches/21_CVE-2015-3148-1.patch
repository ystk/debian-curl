From f78ae415d24b9bd89d6c121c556e411fdb21c6aa Mon Sep 17 00:00:00 2001
From: David Woodhouse <David.Woodhouse@intel.com>
Date: Fri, 11 Jul 2014 11:09:34 +0100
Subject: [PATCH] Don't clear GSSAPI state between each exchange in the
 negotiation

GSSAPI doesn't work very well if we forget everything ever time.

XX: Is Curl_http_done() the right place to do the final cleanup?
---
 lib/http.c                | 6 ++++++
 lib/http_negotiate.c      | 1 -
 lib/http_negotiate_sspi.c | 1 -
 3 files changed, 6 insertions(+), 2 deletions(-)

Index: curl-7.21.0/lib/http.c
===================================================================
--- curl-7.21.0.orig/lib/http.c	2015-04-26 19:44:10.000000000 +0200
+++ curl-7.21.0/lib/http.c	2015-04-26 19:44:10.000000000 +0200
@@ -1893,6 +1893,12 @@
 
   Curl_unencode_cleanup(conn);
 
+#ifdef USE_HTTP_NEGOTIATE
+  if(data->state.proxyneg.state == GSS_AUTHSENT ||
+      data->state.negotiate.state == GSS_AUTHSENT)
+    Curl_cleanup_negotiate(data);
+#endif
+
   /* set the proper values (possibly modified on POST) */
   conn->fread_func = data->set.fread_func; /* restore */
   conn->fread_in = data->set.in; /* restore */
Index: curl-7.21.0/lib/http_negotiate.c
===================================================================
--- curl-7.21.0.orig/lib/http_negotiate.c	2015-04-26 19:44:10.000000000 +0200
+++ curl-7.21.0/lib/http_negotiate.c	2015-04-26 19:44:28.000000000 +0200
@@ -334,7 +334,6 @@
     aprintf("%sAuthorization: %s %s\r\n", proxy ? "Proxy-" : "",
             neg_ctx->protocol, encoded);
   free(encoded);
-  Curl_cleanup_negotiate (conn->data);
   return (conn->allocptr.userpwd == NULL) ? CURLE_OUT_OF_MEMORY : CURLE_OK;
 }
 
