Description: Reject incoming cookies set for TLDs
Origin: upstream, http://curl.haxx.se/libcurl-cookie-leak.patch
Forwarded: not-needed
Author: Daniel Stenberg <daniel@haxx.se>
Last-Update: 2014-09-06

Index: curl-7.21.0/lib/cookie.c
===================================================================
--- curl-7.21.0.orig/lib/cookie.c	2014-09-22 16:18:34.000000000 +0200
+++ curl-7.21.0/lib/cookie.c	2014-09-22 16:18:34.000000000 +0200
@@ -340,12 +340,18 @@
               /* Now, we make sure that our host is within the given domain,
                  or the given domain is not valid and thus cannot be set. */
               bool is_ip;
+              const char *dotp;
 
               if('.' == whatptr[0])
                 whatptr++; /* ignore preceeding dot */
 
               is_ip = isip(domain ? domain : whatptr);
 
+              /* check for more dots */
+              dotp = strchr(whatptr, '.');
+              if(!dotp)
+                domain=":";
+
               if(!domain
                  || (is_ip && !strcmp(whatptr, domain))
                  || (!is_ip && tailmatch(whatptr, domain))) {
Index: curl-7.21.0/tests/data/test61
===================================================================
--- curl-7.21.0.orig/tests/data/test61	2014-09-22 16:18:34.000000000 +0200
+++ curl-7.21.0/tests/data/test61	2014-09-22 16:20:22.000000000 +0200
@@ -22,6 +22,7 @@
 Set-Cookie: test3=maybe; domain=foo.com; path=/moo; secure
 Set-Cookie: test4=no; domain=nope.foo.com; path=/moo; secure
 Set-Cookie: test5=name; domain=anything.com; path=/ ; secure
+Set-Cookie: supercookie=fooledyou; domain=.com; path=/;
 Content-Length: 4
 
 boo
@@ -63,9 +64,8 @@
 # http://curl.haxx.se/rfc/cookie_spec.html
 # This file was generated by libcurl! Edit at your own risk.
 
-#HttpOnly_.foo.com	TRUE	/we/want/	FALSE	2054030187	test	yes
-.host.foo.com	TRUE	/we/want/	FALSE	2054030187	test2	yes
-.foo.com	TRUE	/moo	TRUE	0	test3	maybe
+www.host.foo.com	FALSE	/moo	TRUE	0	test4	no
+www.host.foo.com	FALSE	/	TRUE	0	test5	name
 </file>
 </verify>
 </testcase>
