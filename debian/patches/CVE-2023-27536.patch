From: Markus Koschany <apo@debian.org>
Date: Sat, 8 Apr 2023 16:39:28 +0200
Subject: CVE-2023-27536

Origin: https://github.com/curl/curl/commit/cb49e67303dbafbab1cebf4086e3ec15b7d56ee5
---
 lib/url.c     | 7 +++++++
 lib/urldata.h | 1 +
 2 files changed, 8 insertions(+)

diff --git a/lib/url.c b/lib/url.c
index f78d799..580ecc7 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -3150,6 +3150,12 @@ ConnectionExists(struct SessionHandle *data,
         }
       }
 
+      /* GSS delegation differences do not actually affect every connection
+         and auth method, but this check takes precaution before efficiency */
+      if(needle->gssapi_delegation != check->gssapi_delegation)
+        continue;
+
+
       if(needle->handler->protocol == CURLPROTO_SCP ||
          needle->handler->protocol == CURLPROTO_SFTP) {
 
@@ -3759,6 +3765,7 @@ static struct connectdata *allocate_conn(struct SessionHandle *data)
      it may live on without (this specific) SessionHandle */
   conn->fclosesocket = data->set.fclosesocket;
   conn->closesocket_client = data->set.closesocket_client;
+  conn->gssapi_delegation = data->set.gssapi_delegation;
 
   return conn;
   error:
diff --git a/lib/urldata.h b/lib/urldata.h
index a006efc..f80a3ad 100644
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -1074,6 +1074,7 @@ struct connectdata {
   char *localdev;
   unsigned short localport;
   int localportrange;
+  unsigned char gssapi_delegation; /* inherited from set.gssapi_delegation */
 
   /* tunnel as in tunnel through a HTTP proxy with CONNECT */
   enum {
