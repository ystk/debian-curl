From: Markus Koschany <apo@debian.org>
Date: Wed, 17 Aug 2022 01:34:01 +0200
Subject: CVE-2022-22576

Origin: https://github.com/curl/curl/commit/852aa5ad351ea53e5f01d2f44b5b4370c2bf5425
Bug-Debian: https://bugs.debian.org/1010295
---
 lib/url.c       |  3 ++-
 lib/vtls/vtls.c | 26 +++++++++++++-------------
 lib/vtls/vtls.h |  2 ++
 3 files changed, 17 insertions(+), 14 deletions(-)

diff --git a/lib/url.c b/lib/url.c
index 47cd287..bbe2997 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -3136,7 +3136,8 @@ ConnectionExists(struct SessionHandle *data,
         /* This protocol requires credentials per connection,
            so verify that we're using the same name and password as well */
         if(strcmp(needle->user, check->user) ||
-           strcmp(needle->passwd, check->passwd)) {
+           strcmp(needle->passwd, check->passwd) ||
+           !Curl_safecmp(needle->xoauth2_bearer, check->xoauth2_bearer)) {
           /* one of them was different */
           continue;
         }
diff --git a/lib/vtls/vtls.c b/lib/vtls/vtls.c
index 769d0c1..ea083b0 100644
--- a/lib/vtls/vtls.c
+++ b/lib/vtls/vtls.c
@@ -90,14 +90,14 @@
                                  (data->share->specifier &             \
                                   (1<<CURL_LOCK_DATA_SSL_SESSION)))
 
-static bool safe_strequal(char* str1, char* str2)
+/* Compare case-sensitive NUL-terminated strings, taking care of possible
+ * null pointers. Return true if arguments match.
+ */
+bool Curl_safecmp(char *a, char *b)
 {
-  if(str1 && str2)
-    /* both pointers point to something then compare them */
-    return (0 != Curl_raw_equal(str1, str2)) ? TRUE : FALSE;
-  else
-    /* if both pointers are NULL then treat them as equal */
-    return (!str1 && !str2) ? TRUE : FALSE;
+  if(a && b)
+    return !strcmp(a, b);
+  return !a && !b;
 }
 
 bool
@@ -107,12 +107,12 @@ Curl_ssl_config_matches(struct ssl_config_data* data,
   if((data->version == needle->version) &&
      (data->verifypeer == needle->verifypeer) &&
      (data->verifyhost == needle->verifyhost) &&
-     safe_strequal(data->CApath, needle->CApath) &&
-     safe_strequal(data->CAfile, needle->CAfile) &&
-     safe_strequal(data->clientcert, needle->clientcert) &&
-     safe_strequal(data->random_file, needle->random_file) &&
-     safe_strequal(data->egdsocket, needle->egdsocket) &&
-     safe_strequal(data->cipher_list, needle->cipher_list))
+     Curl_safecmp(data->CApath, needle->CApath) &&
+     Curl_safecmp(data->CAfile, needle->CAfile) &&
+     Curl_safecmp(data->clientcert, needle->clientcert) &&
+     Curl_safecmp(data->random_file, needle->random_file) &&
+     Curl_safecmp(data->egdsocket, needle->egdsocket) &&
+     Curl_safecmp(data->cipher_list, needle->cipher_list))
     return TRUE;
 
   return FALSE;
diff --git a/lib/vtls/vtls.h b/lib/vtls/vtls.h
index e21fdef..a0b50ce 100644
--- a/lib/vtls/vtls.h
+++ b/lib/vtls/vtls.h
@@ -31,6 +31,8 @@
 #define ALPN_HTTP_1_1_LENGTH 8
 #define ALPN_HTTP_1_1 "http/1.1"
 
+bool Curl_safecmp(char *a, char *b);
+
 bool Curl_ssl_config_matches(struct ssl_config_data* data,
                              struct ssl_config_data* needle);
 bool Curl_clone_ssl_config(struct ssl_config_data* source,
