commit 364f174724ef115c63d5e5dc1d3342c8a43b1cca
Author: Patrick Monnerat <patrick@monnerat.net>
Date:   Wed Sep 8 11:56:22 2021 +0200

    imap,pop3: do not ignore --ssl-reqd
    
    In imap and pop3, check if TLS is required even when capabilities
    request has failed.
    
    Bug: https://curl.se/docs/CVE-2021-22946.html
    
    CVE-2021-22946

Index: curl-7.38.0/lib/imap.c
===================================================================
--- curl-7.38.0.orig/lib/imap.c	2021-09-29 23:31:02.324580535 +0200
+++ curl-7.38.0/lib/imap.c	2021-09-29 23:31:02.320580541 +0200
@@ -940,22 +940,19 @@
       line += wordlen;
     }
   }
-  else if(imapcode == 'O') {
-    if(data->set.use_ssl && !conn->ssl[FIRSTSOCKET].use) {
-      /* We don't have a SSL/TLS connection yet, but SSL is requested */
-      if(imapc->tls_supported)
-        /* Switch to TLS connection now */
-        result = imap_perform_starttls(conn);
-      else if(data->set.use_ssl == CURLUSESSL_TRY)
-        /* Fallback and carry on with authentication */
-        result = imap_perform_authentication(conn);
-      else {
-        failf(data, "STARTTLS not supported.");
-        result = CURLE_USE_SSL_FAILED;
-      }
+  else if(data->set.use_ssl && !conn->ssl[FIRSTSOCKET].use) {
+    /* PREAUTH is not compatible with STARTTLS. This version does not support preauth yet */
+    //if(imapcode == 'O' && imapc->tls_supported && !imapc->preauth) {
+    if(imapcode == 'O' && imapc->tls_supported) {
+      /* Switch to TLS connection now */
+      result = imap_perform_starttls(conn);
     }
-    else
+    else if(data->set.use_ssl <= CURLUSESSL_TRY)
       result = imap_perform_authentication(conn);
+    else {
+      failf(data, "STARTTLS not supported.");
+      result = CURLE_USE_SSL_FAILED;
+    }
   }
   else
     result = imap_perform_authentication(conn);
Index: curl-7.38.0/lib/pop3.c
===================================================================
--- curl-7.38.0.orig/lib/pop3.c	2021-09-29 23:31:02.324580535 +0200
+++ curl-7.38.0/lib/pop3.c	2021-09-29 23:31:02.320580541 +0200
@@ -767,28 +767,23 @@
       }
     }
   }
-  else if(pop3code == '+') {
-    if(data->set.use_ssl && !conn->ssl[FIRSTSOCKET].use) {
-      /* We don't have a SSL/TLS connection yet, but SSL is requested */
-      if(pop3c->tls_supported)
-        /* Switch to TLS connection now */
-        result = pop3_perform_starttls(conn);
-      else if(data->set.use_ssl == CURLUSESSL_TRY)
-        /* Fallback and carry on with authentication */
-        result = pop3_perform_authentication(conn);
-      else {
-        failf(data, "STLS not supported.");
-        result = CURLE_USE_SSL_FAILED;
-      }
-    }
-    else
-      result = pop3_perform_authentication(conn);
-  }
   else {
     /* Clear text is supported when CAPA isn't recognised */
-    pop3c->authtypes |= POP3_TYPE_CLEARTEXT;
+    if(pop3code != '+')
+      pop3c->authtypes |= POP3_TYPE_CLEARTEXT;
 
-    result = pop3_perform_authentication(conn);
+     if(!data->set.use_ssl || conn->ssl[FIRSTSOCKET].use)
+       result = pop3_perform_authentication(conn);
+     else if(pop3code == '+' && pop3c->tls_supported)
+       /* Switch to TLS connection now */
+       result = pop3_perform_starttls(conn);
+     else if(data->set.use_ssl <= CURLUSESSL_TRY)
+       /* Fallback and carry on with authentication */
+       result = pop3_perform_authentication(conn);
+     else {
+       failf(data, "STLS not supported.");
+       result = CURLE_USE_SSL_FAILED;
+     }
   }
 
   return result;
Index: curl-7.38.0/tests/data/Makefile.am
===================================================================
--- curl-7.38.0.orig/tests/data/Makefile.am	2021-09-29 23:31:02.324580535 +0200
+++ curl-7.38.0/tests/data/Makefile.am	2021-09-29 23:31:02.320580541 +0200
@@ -84,6 +84,8 @@
 test927 test928 test929 test930 test931 test932 test933 test934 test935 \
 test936 test937 test938 test939 test940 \
 \
+test984 test985 \
+\
 test1000 test1001 test1002 test1003 test1004 test1005 test1006 test1007 \
 test1008 test1009 test1010 test1011 test1012 test1013 test1014 test1015 \
 test1016 test1017 test1018 test1019 test1020 test1021 test1022 test1023 \
Index: curl-7.38.0/tests/data/test984
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ curl-7.38.0/tests/data/test984	2021-09-29 23:31:02.320580541 +0200
@@ -0,0 +1,56 @@
+<testcase>
+<info>
+<keywords>
+IMAP
+STARTTLS
+</keywords>
+</info>
+
+#
+# Server-side
+<reply>
+<servercmd>
+REPLY CAPABILITY A001 BAD Not implemented
+</servercmd>
+</reply>
+
+#
+# Client-side
+<client>
+<features>
+SSL
+</features>
+<server>
+imap
+</server>
+ <name>
+IMAP require STARTTLS with failing capabilities
+ </name>
+ <command>
+imap://%HOSTIP:%IMAPPORT/%TESTNUMBER -T log/upload%TESTNUMBER -u user:secret --ssl-reqd
+</command>
+<file name="log/upload%TESTNUMBER">
+Date: Mon, 7 Feb 1994 21:52:25 -0800 (PST)
+From: Fred Foobar <foobar@example.COM>
+Subject: afternoon meeting
+To: joe@example.com
+Message-Id: <B27397-0100000@example.COM>
+MIME-Version: 1.0
+Content-Type: TEXT/PLAIN; CHARSET=US-ASCII
+
+Hello Joe, do you think we can meet at 3:30 tomorrow?
+</file>
+</client>
+
+#
+# Verify data after the test has been "shot"
+<verify>
+# 64 is CURLE_USE_SSL_FAILED
+<errorcode>
+64
+</errorcode>
+<protocol>
+A001 CAPABILITY
+</protocol>
+</verify>
+</testcase>
Index: curl-7.38.0/tests/data/test985
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ curl-7.38.0/tests/data/test985	2021-09-29 23:31:02.320580541 +0200
@@ -0,0 +1,54 @@
+<testcase>
+<info>
+<keywords>
+POP3
+STARTTLS
+</keywords>
+</info>
+
+#
+# Server-side
+<reply>
+<servercmd>
+REPLY CAPA -ERR Not implemented
+</servercmd>
+<data nocheck="yes">
+From: me@somewhere
+To: fake@nowhere
+
+body
+
+--
+  yours sincerely
+</data>
+</reply>
+
+#
+# Client-side
+<client>
+<features>
+SSL
+</features>
+<server>
+pop3
+</server>
+ <name>
+POP3 require STARTTLS with failing capabilities
+ </name>
+ <command>
+pop3://%HOSTIP:%POP3PORT/%TESTNUMBER -u user:secret --ssl-reqd
+ </command>
+</client>
+
+#
+# Verify data after the test has been "shot"
+<verify>
+# 64 is CURLE_USE_SSL_FAILED
+<errorcode>
+64
+</errorcode>
+<protocol>
+CAPA
+</protocol>
+</verify>
+</testcase>
